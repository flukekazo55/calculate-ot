<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculate OT (V1.0)</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- ✅ โหลดฟอนต์ Kanit จาก Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --tbv-green: #006341;
        --tbv-green-light: #007a53;
        --tbv-gold: #c5a572;
        --tbv-bg: #e8f0eb;
        --tbv-text: #1a1a1a;
      }

      /* ✅ ฟอนต์ Kanit ทั้งเว็บ */
      body,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      p,
      label,
      input,
      select,
      button,
      div,
      span {
        font-family: "Kanit", sans-serif !important;
      }

      body {
        background: var(--tbv-bg);
        color: var(--tbv-text);
      }

      h1,
      h5 {
        color: var(--tbv-green);
        font-weight: 700;
      }

      .card {
        background: #fff;
        border-color: var(--tbv-green);
        border-width: 1.5px;
        border-radius: 12px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      }

      .btn-accent {
        background: var(--tbv-green);
        border: none;
        color: #fff;
        font-weight: 600;
      }
      .btn-accent:hover {
        background: var(--tbv-green-light);
        color: #fff;
      }

      .btn-danger {
        background: #b30000;
        border: none;
      }

      .form-control,
      .form-select {
        border-color: var(--tbv-green-light);
      }

      .alert-info {
        background: var(--tbv-green-light);
        color: #fff;
        border: none;
        font-weight: 500;
      }

      #grandTotal {
        color: var(--tbv-gold);
      }

      .mono {
        font-family: "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="fw-bold mb-2">ตัวคิดเวลา OT (ประเทศไทย)</h1>

      <div
        class="alert alert-info"
        id="initBalance"
        style="display: none"
      ></div>

      <div class="row g-3">
        <!-- บันทึก OT -->
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="fw-bold">บันทึก OT</h5>
              <div class="row g-3 mt-1">
                <div class="col-md-6">
                  <label class="form-label">ประเภทวัน</label>
                  <select id="dayType" class="form-select">
                    <option value="weekday">วันธรรมดา (จ.-ศ.)</option>
                    <option value="weekend">เสาร์ / อาทิตย์</option>
                    <option value="holiday">วันหยุดพิเศษ</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">กิจกรรม</label>
                  <input
                    id="activity"
                    type="text"
                    class="form-control"
                    placeholder="เช่น แก้ระบบหลังบ้าน"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">เริ่ม (24 ชม.)</label>
                  <input
                    id="startTime"
                    type="text"
                    class="form-control"
                    value="17:00"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">สิ้นสุด (24 ชม.)</label>
                  <input
                    id="endTime"
                    type="text"
                    class="form-control"
                    value="20:00"
                  />
                </div>
              </div>
              <div class="d-flex gap-2 mt-3">
                <button id="calcBtn" class="btn btn-accent">
                  คำนวณ & บันทึก
                </button>
                <button id="resetBtn" class="btn btn-danger">
                  ล้างข้อมูลทั้งหมด
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ใช้ OT -->
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="fw-bold">ใช้ OT</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">เวลาที่ใช้ (hh:mm)</label>
                  <input
                    id="useTime"
                    type="text"
                    class="form-control"
                    placeholder="เช่น 02:30"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">หมายเหตุ</label>
                  <input
                    id="useNote"
                    type="text"
                    class="form-control"
                    placeholder="เช่น ใช้ชดเชย #Leave"
                  />
                </div>
              </div>
              <button id="useBtn" class="btn btn-accent mt-3">
                บันทึกการใช้ OT
              </button>
            </div>
          </div>
        </div>

        <!-- ยอดสะสม -->
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="fw-bold">ประวัติทั้งหมด</h5>
              <div id="summaryList" class="mono text-muted"></div>
              <hr class="border-secondary" />
              <div id="grandTotal" class="fs-5 fw-bold">
                รวมทั้งหมด: 0 ชั่วโมง 0 นาที
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const $ = (s) => document.querySelector(s);
      const toHM = (h) => {
        const t = Math.round(h * 60);
        const H = Math.floor(t / 60);
        const M = t % 60;
        return { H, M, text: `${H} ชั่วโมง ${M} นาที` };
      };
      const parseTime = (t) => {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      };
      const parseHHMM = (t) => {
        if (!/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(t)) return null;
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      };
      function calcWeighted(type, s, e) {
        const dur = e - s;
        const b = parseTime("17:00");
        let w = 0;
        if (type === "weekday") w = dur * 1.5;
        else if (type === "holiday") w = dur * 2;
        else {
          if (e <= b) w = dur;
          else if (s >= b) w = dur * 1.5;
          else w = (b - s) * 1 + (e - b) * 1.5;
        }
        return { weightedMin: w, duration: dur };
      }
      async function loadData() {
        const r = await fetch("/load");
        const d = await r.json();
        localStorage.setItem("otRecords", JSON.stringify(d.records));
        localStorage.setItem("otLastUpdate", d.lastUpdate);
        renderSummary(true);
      }
      async function saveData() {
        const data = {
          records: JSON.parse(localStorage.getItem("otRecords") || "[]"),
          lastUpdate: new Date().toLocaleString("th-TH"),
        };
        await fetch("/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
      }
      async function resetData() {
        if (confirm("ล้างข้อมูลทั้งหมด?")) {
          await fetch("/reset", { method: "POST" });
          localStorage.clear();
          renderSummary();
        }
      }
      function calc() {
        const type = $("#dayType").value,
          act = $("#activity").value || "ไม่ระบุ";
        const s = parseTime($("#startTime").value),
          e = parseTime($("#endTime").value);
        if (e <= s) return alert("เวลาสิ้นสุดต้องมากกว่าเวลาเริ่ม");
        const { weightedMin } = calcWeighted(type, s, e);
        saveRecord("earn", weightedMin / 60, act, type);
        alert(`บันทึกสำเร็จ: ${act} (${toHM(weightedMin / 60).text})`);
      }
      function useOT() {
        const timeText = $("#useTime").value.trim();
        const min = parseHHMM(timeText);
        if (min === null) return alert("กรอกเวลาแบบ hh:mm เช่น 02:30");
        const hr = min / 60;
        const note = $("#useNote").value || "ใช้ OT";
        const list = JSON.parse(localStorage.getItem("otRecords") || "[]");
        const before = list.reduce((a, b) => a + b.value, 0),
          after = before - hr;
        if (after < 0) return alert("❌ ใช้ OT เกินยอดที่มีอยู่!");
        const formatted = `[${note}] วันที่ ${new Date().toLocaleDateString(
          "th-TH"
        )} [ใช้ ${toHM(hr).text}] ใช้วันหยุด OT จาก [${
          toHM(before).text
        }] เหลือ [${toHM(after).text}] #Leave`;
        saveRecord("use", -hr, note, "use", formatted);
        alert(`ใช้ OT ไป ${toHM(hr).text}, เหลือ ${toHM(after).text}`);
      }
      function saveRecord(type, value, activity, dayType, formatted = "") {
        const list = JSON.parse(localStorage.getItem("otRecords") || "[]");
        list.push({
          id: Date.now(),
          date: new Date().toLocaleDateString("th-TH"),
          type,
          activity,
          dayType,
          value,
          formatted,
        });
        localStorage.setItem("otRecords", JSON.stringify(list));
        localStorage.setItem(
          "otLastUpdate",
          new Date().toLocaleString("th-TH")
        );
        saveData();
        renderSummary();
      }
      function renderSummary(showInit = false) {
        const list = JSON.parse(localStorage.getItem("otRecords") || "[]");
        const s = $("#summaryList");
        s.innerHTML = "";
        let total = 0;
        list.forEach((r, i) => {
          total += r.value;
          const div = document.createElement("div");
          div.textContent =
            r.type === "use"
              ? r.formatted
              : `${i + 1}. [${r.date}] ${r.activity} → ${toHM(r.value).text}`;
          s.appendChild(div);
        });
        const t = toHM(total);
        $("#grandTotal").textContent = `รวมทั้งหมด: ${t.text}`;
        if (showInit) {
          const box = $("#initBalance");
          box.textContent = `ยอด OT ปัจจุบันทั้งหมด: ${t.text}`;
          box.style.display = "block";
        }
      }
      $("#calcBtn").addEventListener("click", calc);
      $("#resetBtn").addEventListener("click", resetData);
      $("#useBtn").addEventListener("click", useOT);
      loadData();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
