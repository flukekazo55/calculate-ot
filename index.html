<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculate OT (V1.0)</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- ✅ โหลดฟอนต์ Kanit จาก Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --tbv-green: #006341;
        --tbv-green-light: #007a53;
        --tbv-gold: #c5a572;
        --tbv-bg: #e8f0eb;
        --tbv-text: #1a1a1a;
      }

      /* ✅ ฟอนต์ Kanit ทั้งเว็บ */
      body,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      p,
      label,
      input,
      select,
      button,
      div,
      span {
        font-family: "Kanit", sans-serif !important;
      }

      body {
        background: var(--tbv-bg);
        color: var(--tbv-text);
      }

      h1,
      h5 {
        color: var(--tbv-green);
        font-weight: 700;
      }

      .card {
        background: #fff;
        border-color: var(--tbv-green);
        border-width: 1.5px;
        border-radius: 12px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      }

      .btn-accent {
        background: var(--tbv-green);
        border: none;
        color: #fff;
        font-weight: 600;
      }
      .btn-accent:hover {
        background: var(--tbv-green-light);
        color: #fff;
      }

      .btn-danger {
        background: #b30000;
        border: none;
      }

      .form-control,
      .form-select {
        border-color: var(--tbv-green-light);
      }

      .alert-info {
        background: var(--tbv-green-light);
        color: #fff;
        border: none;
        font-weight: 500;
      }

      #grandTotal {
        color: var(--tbv-gold);
      }

      .mono {
        font-family: "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="fw-bold mb-2" data-i18n="heading">ตัวคิดเวลา OT</h1>

      <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
        <label
          for="languageSelect"
          class="form-label mb-0"
          data-i18n="languageLabel"
        >
          ภาษา
        </label>
        <select
          id="languageSelect"
          class="form-select form-select-sm"
          style="max-width: 160px"
        >
          <option value="th">ไทย (TH)</option>
          <option value="en">English (EN)</option>
        </select>
      </div>

      <div
        class="alert alert-info"
        id="initBalance"
        style="display: none"
      ></div>

      <div class="row g-3">
        <!-- บันทึก OT -->
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="fw-bold" data-i18n="calcCardTitle">บันทึก OT</h5>
              <div class="row g-3 mt-1">
                <div class="col-md-6">
                  <label class="form-label" data-i18n="dayTypeLabel">ประเภทวัน</label>
                  <select id="dayType" class="form-select">
                    <option value="weekday" data-i18n="dayType.weekday">
                      วันธรรมดา (จ.-ศ.)
                    </option>
                    <option value="weekend" data-i18n="dayType.weekend">
                      เสาร์ / อาทิตย์
                    </option>
                    <option value="holiday" data-i18n="dayType.holiday">
                      วันหยุดพิเศษ
                    </option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label" data-i18n="activityLabel">กิจกรรม</label>
                  <input
                    id="activity"
                    type="text"
                    class="form-control"
                    placeholder="เช่น แก้ระบบหลังบ้าน"
                    data-i18n-placeholder="activityPlaceholder"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" data-i18n="startLabel">เริ่ม (24 ชม.)</label>
                  <input
                    id="startTime"
                    type="text"
                    class="form-control"
                    value="17:00"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" data-i18n="endLabel">สิ้นสุด (24 ชม.)</label>
                  <input
                    id="endTime"
                    type="text"
                    class="form-control"
                    value="20:00"
                  />
                </div>
              </div>
              <div class="d-flex gap-2 mt-3">
                <button id="calcBtn" class="btn btn-accent" data-i18n="calcBtn">
                  คำนวณ & บันทึก
                </button>
                <button id="resetBtn" class="btn btn-danger" data-i18n="resetBtn">
                  ล้างข้อมูลทั้งหมด
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ใช้ OT -->
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="fw-bold" data-i18n="useCardTitle">ใช้ OT</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" data-i18n="useTimeLabel">เวลาที่ใช้ (hh:mm)</label>
                  <input
                    id="useTime"
                    type="text"
                    class="form-control"
                    placeholder="เช่น 02:30"
                    data-i18n-placeholder="useTimePlaceholder"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" data-i18n="useNoteLabel">หมายเหตุ</label>
                  <input
                    id="useNote"
                    type="text"
                    class="form-control"
                    placeholder="เช่น ใช้ชดเชย #Leave"
                    data-i18n-placeholder="useNotePlaceholder"
                  />
                </div>
              </div>
              <button
                id="useBtn"
                class="btn btn-accent mt-3"
                data-i18n="useBtn"
              >
                บันทึกการใช้ OT
              </button>
            </div>
          </div>
        </div>

        <!-- ยอดสะสม -->
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="fw-bold" data-i18n="historyTitle">ประวัติทั้งหมด</h5>
              <div id="summaryList" class="mono text-muted"></div>
              <hr class="border-secondary" />
              <div id="grandTotal" class="fs-5 fw-bold">
                รวมทั้งหมด: 0 ชั่วโมง 0 นาที
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      const localeMap = { th: "th-TH", en: "en-US" };
      const translations = {
        th: {
          appTitle: "Calculate OT (V1.0)",
          heading: "ตัวคิดเวลา OT",
          calcCardTitle: "บันทึก OT",
          dayTypeLabel: "ประเภทวัน",
          "dayType.weekday": "วันธรรมดา (จ.-ศ.)",
          "dayType.weekend": "เสาร์ / อาทิตย์",
          "dayType.holiday": "วันหยุดพิเศษ",
          activityLabel: "กิจกรรม",
          activityPlaceholder: "เช่น แก้ระบบหลังบ้าน",
          startLabel: "เริ่ม (24 ชม.)",
          endLabel: "สิ้นสุด (24 ชม.)",
          calcBtn: "คำนวณ & บันทึก",
          resetBtn: "ล้างข้อมูลทั้งหมด",
          useCardTitle: "ใช้ OT",
          useTimeLabel: "เวลาที่ใช้ (hh:mm)",
          useTimePlaceholder: "เช่น 02:30",
          useNoteLabel: "หมายเหตุ",
          useNotePlaceholder: "เช่น ใช้ชดเชย #Leave",
          useBtn: "บันทึกการใช้ OT",
          historyTitle: "ประวัติทั้งหมด",
          grandTotalLabel: "รวมทั้งหมด",
          initBalanceLabel: "ยอด OT ปัจจุบันทั้งหมด",
          languageLabel: "ภาษา",
          okBtn: "ตกลง",
          cancelBtn: "ยกเลิก",
          infoTitle: "แจ้งเตือน",
          successTitle: "สำเร็จ",
          errorTitle: "เกิดข้อผิดพลาด",
          confirmResetTitle: "ยืนยันการล้างข้อมูล?",
          defaultActivity: "ไม่ระบุ",
          useDefaultNote: "ใช้ OT",
          confirmReset: "ล้างข้อมูลทั้งหมด?",
          resetSuccess: "ล้างข้อมูลเรียบร้อยแล้ว",
          calcInvalidRange: "เวลาสิ้นสุดต้องมากกว่าเวลาเริ่ม",
          calcSuccess: (activity, durationText) =>
            `บันทึกสำเร็จ: ${activity} (${durationText})`,
          useInvalidFormat: "กรอกเวลาแบบ hh:mm เช่น 02:30",
          useOverLimit: "❌ ใช้ OT เกินยอดที่มีอยู่!",
          useAlert: (usedText, remainText) =>
            `ใช้ OT ไป ${usedText}, เหลือ ${remainText}`,
          formatUseEntry: ({ note, dateText, usedText, beforeText, afterText }) =>
            `[${note}] วันที่ ${dateText} [ใช้ ${usedText}] ใช้วันหยุด OT จาก [${beforeText}] เหลือ [${afterText}] #Leave`,
          hourUnit: "ชั่วโมง",
          minuteUnit: "นาที",
        },
        en: {
          appTitle: "Calculate OT (V1.0)",
          heading: "Calculate OT",
          calcCardTitle: "Add OT Entry",
          dayTypeLabel: "Day Type",
          "dayType.weekday": "Weekday (Mon-Fri)",
          "dayType.weekend": "Weekend / Day Off",
          "dayType.holiday": "Holiday",
          activityLabel: "Activity",
          activityPlaceholder: "e.g., Fix back office system",
          startLabel: "Start (24h)",
          endLabel: "End (24h)",
          calcBtn: "Calculate & Save",
          resetBtn: "Clear All",
          useCardTitle: "Use OT",
          useTimeLabel: "Time to use (hh:mm)",
          useTimePlaceholder: "e.g., 02:30",
          useNoteLabel: "Note",
          useNotePlaceholder: "e.g., Offset #Leave",
          useBtn: "Save OT Usage",
          historyTitle: "Full History",
          grandTotalLabel: "Total",
          initBalanceLabel: "Current OT Balance",
          languageLabel: "Language",
          okBtn: "OK",
          cancelBtn: "Cancel",
          infoTitle: "Notice",
          successTitle: "Success",
          errorTitle: "Something went wrong",
          confirmResetTitle: "Reset all data?",
          defaultActivity: "Unspecified",
          useDefaultNote: "Use OT",
          confirmReset: "Clear every record?",
          resetSuccess: "All records have been cleared.",
          calcInvalidRange: "End time must be later than start time",
          calcSuccess: (activity, durationText) =>
            `Saved successfully: ${activity} (${durationText})`,
          useInvalidFormat: "Enter time as hh:mm, e.g., 02:30",
          useOverLimit: "❌ You cannot use more OT than you have!",
          useAlert: (usedText, remainText) =>
            `Used OT ${usedText}, remaining ${remainText}`,
          formatUseEntry: ({ note, dateText, usedText, beforeText, afterText }) =>
            `[${note}] Date ${dateText} [Used ${usedText}] OT bank from [${beforeText}] left [${afterText}] #Leave`,
          hourUnit: "hours",
          minuteUnit: "minutes",
        },
      };

      let currentLang = localStorage.getItem("otLang") || "th";
      if (!translations[currentLang]) currentLang = "th";

      const $ = (s) => document.querySelector(s);
      const toHM = (h, lang = currentLang) => {
        const pack = translations[lang] || translations.th;
        const totalMinutes = Math.max(0, Math.round(Math.abs(h) * 60));
        const H = Math.floor(totalMinutes / 60);
        const M = totalMinutes % 60;
        return {
          H,
          M,
          text: `${H} ${pack.hourUnit} ${M} ${pack.minuteUnit}`,
        };
      };
      const parseTime = (t) => {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      };
      const LUNCH_START = parseTime("12:00");
      const LUNCH_END = parseTime("13:00");
      // Remove 12:00-13:00 lunch window from a working interval.
      const splitLunch = (start, end) => {
        if (end <= start) return [];
        if (end <= LUNCH_START || start >= LUNCH_END) return [[start, end]];
        const segments = [];
        if (start < LUNCH_START)
          segments.push([start, Math.min(end, LUNCH_START)]);
        if (end > LUNCH_END)
          segments.push([Math.max(start, LUNCH_END), end]);
        return segments.filter(([segStart, segEnd]) => segEnd > segStart);
      };
      const parseHHMM = (t) => {
        if (!/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(t)) return null;
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      };
      const getLocale = (lang = currentLang) =>
        localeMap[lang] || localeMap.en;
      const t = (key, ...args) => {
        const pack = translations[currentLang] || translations.th;
        const value = pack[key];
        if (typeof value === "function") return value(...args);
        return value ?? key;
      };
      const defaultTitleByIcon = {
        success: "successTitle",
        error: "errorTitle",
        info: "infoTitle",
        warning: "infoTitle",
      };
      function showAlertModal({ icon = "info", titleKey, text = "" }) {
        const resolvedKey = titleKey || defaultTitleByIcon[icon];
        const resolvedTitle = resolvedKey ? t(resolvedKey) : "";
        return Swal.fire({
          icon,
          title: resolvedTitle,
          text,
          confirmButtonText: t("okBtn"),
          heightAuto: false,
        });
      }
      const showError = (text) =>
        showAlertModal({ icon: "error", text });
      const showSuccess = (text) =>
        showAlertModal({ icon: "success", text });
      const showInfo = (text) =>
        showAlertModal({ icon: "info", text });
      function patchNativeAlerts() {
        const patched = (message) => {
          const text =
            message === undefined || message === null
              ? ""
              : String(message);
          showInfo(text);
        };
        window.alert = patched;
        try {
          console.alert = patched;
        } catch {
          console.log("console.alert override not supported.");
        }
      }
      async function confirmAction({
        titleKey = "confirmResetTitle",
        textKey = "confirmReset",
      } = {}) {
        const result = await Swal.fire({
          icon: "warning",
          title: t(titleKey),
          text: t(textKey),
          showCancelButton: true,
          confirmButtonText: t("okBtn"),
          cancelButtonText: t("cancelBtn"),
          focusCancel: true,
          heightAuto: false,
        });
        return result.isConfirmed;
      }
      function calcWeighted(type, s, e) {
        const b = parseTime("17:00");
        const segments = splitLunch(s, e);
        let weightedMin = 0;
        segments.forEach(([segStart, segEnd]) => {
          const segDur = segEnd - segStart;
          if (type === "weekday") weightedMin += segDur * 1.5;
          else if (type === "holiday") weightedMin += segDur * 2;
          else {
            if (segEnd <= b) weightedMin += segDur;
            else if (segStart >= b) weightedMin += segDur * 1.5;
            else
              weightedMin +=
                (b - segStart) * 1 + (segEnd - b) * 1.5;
          }
        });
        return { weightedMin };
      }
      async function loadData() {
        const r = await fetch("/load");
        const d = await r.json();
        localStorage.setItem("otRecords", JSON.stringify(d.records));
        localStorage.setItem("otLastUpdate", d.lastUpdate);
        renderSummary(true);
      }
      async function saveData() {
        const data = {
          records: JSON.parse(localStorage.getItem("otRecords") || "[]"),
          lastUpdate: new Date().toLocaleString(getLocale()),
        };
        await fetch("/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
      }
      async function resetData() {
        const confirmed = await confirmAction();
        if (!confirmed) return;
        await fetch("/reset", { method: "POST" });
        localStorage.clear();
        renderSummary();
        await showSuccess(t("resetSuccess"));
      }
      async function calc() {
        const type = $("#dayType").value;
        const actInput = $("#activity");
        const act =
          (actInput?.value || "").trim() || t("defaultActivity");
        const s = parseTime($("#startTime").value);
        const e = parseTime($("#endTime").value);
        if (e <= s) {
          await showError(t("calcInvalidRange"));
          return;
        }
        const { weightedMin } = calcWeighted(type, s, e);
        const earnedHours = weightedMin / 60;
        saveRecord("earn", earnedHours, act, type);
        await showSuccess(t("calcSuccess", act, toHM(earnedHours).text));
      }
      async function useOT() {
        const timeText = ($("#useTime").value || "").trim();
        const min = parseHHMM(timeText);
        if (min === null) {
          await showError(t("useInvalidFormat"));
          return;
        }
        const hr = min / 60;
        const note =
          ($("#useNote").value || "").trim() || t("useDefaultNote");
        const list = JSON.parse(localStorage.getItem("otRecords") || "[]");
        const before = list.reduce(
          (a, b) => a + Number(b.value || 0),
          0
        );
        const after = before - hr;
        if (after < 0) {
          await showError(t("useOverLimit"));
          return;
        }
        const locale = getLocale();
        const dateText = new Date().toLocaleDateString(locale);
        const formatted = t("formatUseEntry", {
          note,
          dateText,
          usedText: toHM(hr).text,
          beforeText: toHM(before).text,
          afterText: toHM(after).text,
        });
        const meta = {
          spentHours: hr,
          beforeHours: before,
          afterHours: after,
        };
        saveRecord("use", -hr, note, "use", formatted, meta);
        await showSuccess(t("useAlert", toHM(hr).text, toHM(after).text));
      }
      function saveRecord(
        type,
        value,
        activity,
        dayType,
        formatted = "",
        meta = null
      ) {
        const list = JSON.parse(localStorage.getItem("otRecords") || "[]");
        const timestamp = Date.now();
        const locale = getLocale();
        const record = {
          id: timestamp,
          timestamp,
          date: new Date(timestamp).toLocaleDateString(locale),
          type,
          activity,
          dayType,
          value,
        };
        if (formatted) record.formatted = formatted;
        if (meta && Object.keys(meta).length) record.meta = meta;
        list.push(record);
        localStorage.setItem("otRecords", JSON.stringify(list));
        localStorage.setItem(
          "otLastUpdate",
          new Date().toLocaleString(locale)
        );
        saveData();
        renderSummary();
      }
      function formatRecordDate(record) {
        if (record?.timestamp)
          return new Date(record.timestamp).toLocaleDateString(
            getLocale()
          );
        return record?.date || "-";
      }
      function formatUseSummary(record) {
        const dateText = formatRecordDate(record);
        const meta = record.meta;
        if (meta && typeof meta.spentHours === "number") {
          return t("formatUseEntry", {
            note: record.activity,
            dateText,
            usedText: toHM(meta.spentHours).text,
            beforeText: toHM(meta.beforeHours || 0).text,
            afterText: toHM(meta.afterHours || 0).text,
          });
        }
        return record.formatted || record.activity || "";
      }
      function renderSummary(showInit = false) {
        const list = JSON.parse(localStorage.getItem("otRecords") || "[]");
        const summary = $("#summaryList");
        if (!summary) return;
        summary.innerHTML = "";
        let total = 0;
        list.forEach((r, i) => {
          total += Number(r.value || 0);
          const div = document.createElement("div");
          div.textContent =
            r.type === "use"
              ? formatUseSummary(r)
              : `${i + 1}. [${formatRecordDate(r)}] ${r.activity} → ${
                  toHM(r.value).text
                }`;
          summary.appendChild(div);
        });
        const totalText = toHM(total).text;
        const totalBox = $("#grandTotal");
        if (totalBox)
          totalBox.textContent = `${t("grandTotalLabel")}: ${totalText}`;
        const initBox = $("#initBalance");
        if (initBox) {
          const shouldShow =
            showInit || initBox.style.display === "block";
          if (shouldShow) {
            initBox.textContent = `${t("initBalanceLabel")}: ${totalText}`;
            initBox.style.display = "block";
          }
        }
      }
      function applyTranslations() {
        document.documentElement.lang = currentLang;
        document.title = t("appTitle");
        document.querySelectorAll("[data-i18n]").forEach((node) => {
          const key = node.getAttribute("data-i18n");
          const value = t(key);
          if (typeof value === "string") node.textContent = value;
        });
        document
          .querySelectorAll("[data-i18n-placeholder]")
          .forEach((node) => {
            const key = node.getAttribute("data-i18n-placeholder");
            const value = t(key);
            if (typeof value === "string")
              node.setAttribute("placeholder", value);
          });
        const initVisible = $("#initBalance")?.style.display === "block";
        renderSummary(initVisible);
      }
      function setupLanguageSelector() {
        const select = $("#languageSelect");
        if (!select) return;
        select.value = currentLang;
        select.addEventListener("change", (event) => {
          const nextLang = event.target.value;
          currentLang = translations[nextLang] ? nextLang : "th";
          localStorage.setItem("otLang", currentLang);
          applyTranslations();
        });
      }
      $("#calcBtn").addEventListener("click", calc);
      $("#resetBtn").addEventListener("click", resetData);
      $("#useBtn").addEventListener("click", useOT);
      patchNativeAlerts();
      setupLanguageSelector();
      applyTranslations();
      loadData();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
